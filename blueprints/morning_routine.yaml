# ============================================================
# BLUEPRINT â€” Routine du matin PeriPage
# ============================================================
# ScÃ©nario : impression quotidienne d'une page personnalisÃ©e
# contenant une image, une phrase d'encouragement, les RDV
# du jour et une phrase finale affectueuse.
#
# PRÃ‰REQUIS :
#   1. L'addon PeriPage Layout installÃ© et configurÃ©
#   2. Trois helpers Ã  crÃ©er dans HA (Settings > Helpers) :
#
#      input_number.peripage_image_count
#        Type : Number | Min : 1 | Max : 9999 | Step : 1
#        â†’ Nombre total d'images dans votre dossier /config/www/images/
#
#      input_select.peripage_encouragements
#        Type : Select
#        â†’ Ajoutez vos phrases d'encouragement comme options
#        Exemples :
#          - "Une chose Ã  la fois, et Ã§a avance !"
#          - "Tu n'as pas besoin d'Ãªtre parfaitÂ·e."
#          - "Chaque petit pas compte. Vraiment."
#
#      input_select.peripage_closings
#        Type : Select
#        â†’ Ajoutez vos phrases finales comme options
#        Exemples :
#          - "Bonne journÃ©e ðŸ’™"
#          - "Tu es aimÃ©Â·e, exactement comme tu es."
#          - "Vas-y Ã  ton rythme."
#
#   3. Vos images nommÃ©es avec un numÃ©ro sur 5 chiffres :
#      image00001.png, image00002.png, ...
#      placÃ©es dans /config/www/images/
#
#   4. Le rest_command ci-dessous dans configuration.yaml
#
# ============================================================


# â”€â”€ Ã€ ajouter dans configuration.yaml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rest_command:
  peripage_print:
    url: "http://YOUR_HA_IP:8766/print"
    method: POST
    content_type: "application/json"
    payload: "{{ payload }}"


# â”€â”€ Script HA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

script:
  peripage_routine_matin:
    alias: "PeriPage â€” Routine du matin"
    description: >
      Imprime une page personnalisÃ©e : image alÃ©atoire,
      phrase d'encouragement, RDV du jour, phrase finale.
    mode: single

    sequence:

      # Ã‰tape 1 â€” Image alÃ©atoire
      - variables:
          image_num: >
            {{ range(1, (states('input_number.peripage_image_count') | int) + 1)
               | list | random }}
          image_url: >
            {{ 'http://YOUR_HA_IP:8123/local/images/image'
               ~ (image_num | string).zfill(5) ~ '.png' }}

      # Ã‰tape 2 â€” Phrase d'encouragement alÃ©atoire
      - variables:
          encouragement: >
            {% set opts = state_attr('input_select.peripage_encouragements', 'options') %}
            {{ opts | random }}

      # Ã‰tape 3 â€” Phrase finale alÃ©atoire
      - variables:
          closing: >
            {% set opts = state_attr('input_select.peripage_closings', 'options') %}
            {{ opts | random }}

      # Ã‰tape 4 â€” RDV du jour depuis les calendriers
      # Adaptez la liste des calendriers Ã  vos entitÃ©s
      - variables:
          rdv_list: >
            {% set calendars = [
              'calendar.mon_calendrier',
              'calendar.calendrier_pro'
            ] %}
            {% set ns = namespace(rdvs=[]) %}
            {% for cal in calendars %}
              {% if states(cal) == 'on' %}
                {% set title = state_attr(cal, 'message') | default('RDV') %}
                {% set start = state_attr(cal, 'start_time') | default('') %}
                {% if start %}
                  {% set heure = start[11:16] %}
                  {% set ns.rdvs = ns.rdvs + [heure ~ ' - ' ~ title] %}
                {% else %}
                  {% set ns.rdvs = ns.rdvs + [title] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ns.rdvs }}

      # Ã‰tape 5 â€” Fallback si aucun RDV
      - variables:
          appointments: >
            {% if rdv_list | length == 0 %}
              {{ ["Aucun RDV aujourd'hui â€” profitez-en !"] }}
            {% else %}
              {{ rdv_list | sort }}
            {% endif %}

      # Ã‰tape 6 â€” Construction du payload et impression
      - service: rest_command.peripage_print
        data:
          payload: >
            {
              "blocks": [
                { "type": "image_url", "url": "{{ image_url }}" },
                { "type": "separator" },
                { "type": "text",
                  "text": "{{ encouragement }}",
                  "align": "center",
                  "font_size": 22 },
                { "type": "separator" },
                { "type": "title", "text": "Aujourd'hui" },
                { "type": "list", "items": {{ appointments | tojson }} },
                { "type": "separator" },
                { "type": "text",
                  "text": "{{ closing }}",
                  "align": "center" }
              ]
            }


# â”€â”€ Automation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

automation:
  - id: "peripage_routine_matin"
    alias: "PeriPage â€” Impression 7h00"
    description: "DÃ©clenche la routine du matin chaque jour Ã  7h"
    trigger:
      - platform: time
        at: "07:00:00"
    condition: []
    action:
      - service: script.peripage_routine_matin
    mode: single
